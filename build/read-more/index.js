(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.blocks,r=window.wp.i18n,s=window.wp.element,a=window.wp.blockEditor,o=window.wp.components,n=window.wp.data,i=window.wp.coreData,d=window.wp.apiFetch;var l=e.n(d);const c=window.wp.primitives,p=window.ReactJSXRuntime,m=(0,p.jsx)(c.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,p.jsx)(c.Path,{d:"M14.6 7l-1.2-1L8 12l5.4 6 1.2-1-4.6-5z"})}),h=(0,p.jsx)(c.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,p.jsx)(c.Path,{d:"M10.6 6L9.4 7l4.6 5-4.6 5 1.2 1 5.4-6z"})}),g=window.wp.date;function u(e,t){const[r,a]=(0,s.useState)(e);return(0,s.useEffect)((()=>{const r=setTimeout((()=>a(e)),t);return()=>clearTimeout(r)}),[e,t]),r}const w=JSON.parse('{"$schema":"https://schemas.wp.org/trunk/block.json","apiVersion":3,"name":"dmg/read-more","version":"0.1.0","title":"DMG Read More","category":"text","icon":"admin-links","description":"Insert a stylised link to a published post.","example":{},"attributes":{"postId":{"type":"number","default":0},"postTitle":{"type":"string","default":""},"postUrl":{"type":"string","default":""}},"supports":{"html":false},"textdomain":"dmg-read-more","editorScript":"file:./index.js","editorStyle":"file:./index.css","style":"file:./style-index.css"}');(0,t.registerBlockType)(w.name,{...w,edit:function({attributes:e,setAttributes:t}){const{postId:d,postTitle:c,postUrl:w}=e,[_,x]=(0,s.useState)(""),[f,j]=(0,s.useState)(""),[b,y]=(0,s.useState)([]),[v,S]=(0,s.useState)(!1),[P,k]=(0,s.useState)(1),[I,T]=(0,s.useState)(1),[E,N]=(0,s.useState)(""),R=(0,s.useRef)(null),M=(0,s.useRef)(new Map),$=u(_,300),C=u(f,300),B=(0,n.useSelect)((e=>e(i.store).getEntityRecords("postType","post",{per_page:5,_fields:"id,title,date,link",status:"publish",orderby:"date",order:"desc"})),[]);(0,s.useEffect)((()=>{!B||_||f||(y(B),T(1),N(""))}),[B]),(0,s.useEffect)((()=>{!d||c&&w||(S(!0),l()({path:`/wp/v2/posts/${d}?_fields=id,title,link`}).then((e=>{t({postTitle:e.title.rendered,postUrl:e.link}),S(!1),N("")})).catch((e=>{t({postId:0,postTitle:"",postUrl:""}),S(!1),N((0,r.__)("Error loading post data. The post may have been deleted.","dmg-read-more")),console.error("API Error:",e)})))}),[d,c,w]);const D=async({term:e="",id:t="",page:s=1}={})=>{S(!0),N("");const a=`${t?"id":"term"}:${t||e}:${s}`;if(M.current.has(a)){const{posts:e,pages:t}=M.current.get(a);return y(e),T(t),void S(!1)}R.current&&R.current.abort();const o=new AbortController;R.current=o;try{if(t){const e=await l()({path:`/wp/v2/posts/${t}?_fields=id,title,date,link`,signal:o.signal}),s=e?[e]:[];return y(s),T(1),M.current.set(a,{posts:s,pages:1}),void(0===s.length&&N((0,r.__)("Post not found. Please check the ID and try again.","dmg-read-more")))}const n=new URLSearchParams({search:e,page:s.toString(),per_page:5..toString(),status:"publish",_fields:"id,title,date,link"}),i=await l()({path:`/wp/v2/posts?${n.toString()}`,parse:!1,signal:o.signal}),d=parseInt(i.headers.get("X-WP-TotalPages")||"1",10),c=await i.json();y(c),T(d),M.current.set(a,{posts:c,pages:d})}catch(e){if(e&&"AbortError"===e.name)return;y([]),T(0),N((0,r.__)("Error searching posts. Please try again later.","dmg-read-more")),console.error("API Error:",e)}finally{S(!1)}},U=e=>{t({postId:e.id,postTitle:e.title.rendered,postUrl:e.link}),N("")};(0,s.useEffect)((()=>{($||C)&&(1===P?$&&$.length<2||D({term:$,id:C,page:1}):k(1))}),[$,C]),(0,s.useEffect)((()=>{($||C)&&($&&$.length<2||D({term:$,id:C,page:P}))}),[P]);const A=(0,a.useBlockProps)({className:"dmg-read-more"});return(0,p.jsxs)(p.Fragment,{children:[" ",(0,p.jsx)(a.InspectorControls,{children:(0,p.jsxs)(o.PanelBody,{title:(0,r.__)("Select Post","dmg-read-more"),children:[(0,p.jsx)(o.SearchControl,{label:(0,r.__)("Search posts","dmg-read-more"),value:_,onChange:e=>{x(e),j(""),k(1),N("")}}),(0,p.jsx)(o.TextControl,{label:(0,r.__)("Or search by Post ID","dmg-read-more"),value:f,onChange:e=>{j(e),x(""),k(1),N("")},type:"number"}),(0,p.jsx)(o.Button,{variant:"primary",onClick:()=>{if(S(!0),N(""),f)return void l()({path:`/wp/v2/posts/${f}?_fields=id,title,date,link`}).then((e=>{y([e]),T(1),S(!1)})).catch((e=>{y([]),T(0),S(!1),N((0,r.__)("Post not found. Please check the ID and try again.","dmg-read-more")),console.error("API Error:",e)}));const e=new URLSearchParams({search:_,page:P.toString(),per_page:5..toString(),status:"publish",_fields:"id,title,date,link"});l()({path:`/wp/v2/posts?${e.toString()}`,parse:!1}).then((e=>{const t=parseInt(e.headers.get("X-WP-TotalPages")||1,10);return e.json().then((e=>{y(e),T(t),S(!1),0===e.length&&N((0,r.__)("No posts found matching your search criteria.","dmg-read-more"))}))})).catch((e=>{y([]),T(0),S(!1),N((0,r.__)("Error searching posts. Please try again later.","dmg-read-more")),console.error("API Error:",e)}))},disabled:!_&&!f||v,className:"dmg-read-more-search-button","aria-busy":v,children:(0,r.__)("Search","dmg-read-more")}),E&&(0,p.jsx)(o.Notice,{status:"error",isDismissible:!1,children:E}),(0,p.jsxs)("div",{className:"dmg-read-more-results-container",children:[(0,p.jsx)("h3",{children:_||f?(0,r.__)("Search Results","dmg-read-more"):(0,r.__)("Recent Posts","dmg-read-more")}),(0,p.jsx)("div",{children:v?(0,p.jsx)(o.Spinner,{}):b&&0!==b.length?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("ul",{className:"dmg-read-more-search-results",role:"listbox","aria-label":(0,r.__)("Posts list","dmg-read-more"),children:b.map((e=>(0,p.jsxs)("li",{className:"dmg-read-more-search-result",onClick:()=>U(e),onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),U(e))},tabIndex:"0",role:"option","aria-selected":e.id===d,children:[(0,p.jsx)("h4",{children:(0,p.jsx)("span",{dangerouslySetInnerHTML:{__html:e.title.rendered}})}),(0,p.jsx)("span",{className:"dmg-read-more-text-muted",children:(0,g.dateI18n)("M j, Y",e.date)})]},e.id)))}),I>1&&(0,p.jsxs)("div",{className:"dmg-read-more-pagination",children:[(0,p.jsx)(o.Button,{variant:"secondary",onClick:()=>k(Math.max(1,P-1)),disabled:P<=1||v,icon:m,label:(0,r.__)("Previous page","dmg-read-more"),showTooltip:!0}),(0,p.jsx)("span",{className:"dmg-read-more-text-muted",children:(0,r.sprintf)(/* translators: 1: Current page number. 2: Total number of pages. */ /* translators: 1: Current page number. 2: Total number of pages. */
(0,r.__)("Page %1$s of %2$s","dmg-read-more"),P,I)}),(0,p.jsx)(o.Button,{variant:"secondary",onClick:()=>k(Math.min(I,P+1)),disabled:P>=I||v,icon:h,label:(0,r.__)("Next page","dmg-read-more"),showTooltip:!0})]})]}):(0,p.jsx)("p",{children:(0,r.__)("No posts found.","dmg-read-more")})})]})]})}),d?(0,p.jsxs)("p",{...A,children:[(0,r.__)("Read more:","dmg-read-more")," ",(0,p.jsx)("a",{href:w,children:c})]}):(0,p.jsx)(o.Placeholder,{label:(0,r.__)("DMG Read More","dmg-read-more"),instructions:(0,r.__)("Select a post from the sidebar to create a stylised link.","dmg-read-more"),icon:"admin-links"})]})},save:function({attributes:e}){const{postTitle:t,postUrl:s}=e;if(!t||!s)return null;const o=a.useBlockProps.save({className:"dmg-read-more"});return(0,p.jsxs)("p",{...o,children:[(0,r.__)("Read more:","dmg-read-more")," ",(0,p.jsxs)("a",{href:s,children:["Read More: ",t]})]})}})})();